<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta name="Content-Type" content="text/html; charset=utf-8" />
<title>Module: Plist4r::Popen4</title>
<link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="../css/common.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="../css/custom.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '..';
  if (relpath != '') relpath += '/';
</script>
<base id="base_target" target="_top" />
<script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="../js/autocomplete.js"></script>
<script type="text/javascript" charset="utf-8" src="../js/app.js"></script>
<script type="text/javascript" charset="utf-8" src="../js/live.js"></script>

  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
		
			<a href="../object_index.html" target="_self" title="Index (P)">Index (P)</a>
		 &raquo;
    <span class='title'><a href="../Plist4r.html" target="_self" title="Plist4r (module)">Plist4r</a></span>
     &raquo; 
    <span class="title">Popen4</span>
  
  
  <div class="noframes">
    <span class="title"></span>
    <a id="frames_link" class="link_disabled">Frames</a> | 
    <a target="_top" id="noframes_link" class="link_disabled">No Frames</a>
    <span class="title"></span>
  </div>
</div>

      <div id="search2">
  
  
  <div class="search2_center">
    <form class="search2" onsubmit="return false;" action="">
      <input name="q" type="search" placeholder="Search" id="search_box2" size="30" value="" />
    </form>
  </div>
  <script type="text/javascript" charset="utf-8"> 
    $('#search_box2').focus(function(){
      var search_index = relpath + 'search_index.json';
      jQuery.getJSON(search_index, go_data);

      function go_data(adata) {
        $('#search_box2').autocomplete(adata, {
          width: 300,
          matchContains: true,
          formatItem: function(item) {
            return item.text;
          }
        }).result(function(event, item) {
					if (window.location.search) {
	          window.location.href = relpath + $(item.href_tag).attr("href");
					} else {
	          location.href = relpath + $(item.href_tag).attr("href");
					}
        });
      }
    });
  </script> 
</div>

      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Module: Plist4r::Popen4
  
  
  
</h1>

<div id="info_box">
  <dl class="box">
    
      
    
      
    
  
    <dt class="r1 last">Defined in:</dt>
		<dd class="r1 last">
  		
  lib/plist4r/mixin/popen4.rb


		</dd>
  </dl>
</div>
<div class="clear"></div>


	<h3 class="inherited">Class Methods</h3>
	    <ul id="methods_ribbon">
	    
	    
	      <li class="r1"><a href="#popen4-class_method" target="_self" title="Plist4r::Popen4.popen4 (method)">popen4</a></li>
	      
	    
	    </ul>





  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>
    
    
      <div class="method_details first" id="popen4-class_method">
  <p class="signature first"">
  
    + (<tt><a href="../Object.html" target="_self" title="Object (class)">Object</a></tt>) <strong>popen4</strong>(cmd, args = {}, &amp;b) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
This is taken directly from Ara T Howard&#8217;s Open4 library, and then
modified to suit the needs of the Chef project.
</p>
<p>
<a href="http://github.com/ahoward/open4">github.com/ahoward/open4</a>
</p>
<p>
<a
href="http://www.ruby-forum.com/topic/54593">www.ruby-forum.com/topic/54593</a>
</p>
<p>
Don&#8217;t use the &#8220;Block form&#8221; calling method. It screws up
on the pipes IO.
</p>
<p>
Use &#8220;Simple form&#8221;, always. Simple form = more robust IO
handling.
</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h3>Examples:</h3>
    
      <h4><div class='inline'><p>
Simple form
</p>
</div></h4>
      <pre class="example code"><span class='def def kw'>def</span> <span class='popen4_exec identifier id'>popen4_exec</span> <span class='stdin_str identifier id'>stdin_str</span><span class='comma token'>,</span> <span class='cmd identifier id'>cmd</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='args identifier id'>args</span>
  <span class='require identifier id'>require</span> <span class='string val'>'plist4r/mixin/popen4'</span>

  <span class='pid identifier id'>pid</span><span class='comma token'>,</span> <span class='stdin identifier id'>stdin</span><span class='comma token'>,</span> <span class='stdout identifier id'>stdout</span><span class='comma token'>,</span> <span class='stderr identifier id'>stderr</span> <span class='assign token'>=</span> <span class='colon3 op'>::</span><span class='Plist4r constant id'>Plist4r</span><span class='colon2 op'>::</span><span class='Popen4 constant id'>Popen4</span><span class='colon2 op'>::</span><span class='popen4 identifier id'>popen4</span> <span class='lbrack token'>[</span><span class='cmd identifier id'>cmd</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='args identifier id'>args</span><span class='rbrack token'>]</span>

    <span class='stdin identifier id'>stdin</span><span class='dot token'>.</span><span class='puts identifier id'>puts</span> <span class='stdin_str identifier id'>stdin_str</span>

    <span class='stdin identifier id'>stdin</span><span class='dot token'>.</span><span class='close identifier id'>close</span>
    <span class='ignored identifier id'>ignored</span><span class='comma token'>,</span> <span class='status identifier id'>status</span> <span class='assign token'>=</span> <span class='Process constant id'>Process</span><span class='colon2 op'>::</span><span class='waitpid2 identifier id'>waitpid2</span> <span class='pid identifier id'>pid</span>

    <span class='stdout_result identifier id'>stdout_result</span> <span class='assign token'>=</span> <span class='stdout identifier id'>stdout</span><span class='dot token'>.</span><span class='read identifier id'>read</span><span class='dot token'>.</span><span class='strip identifier id'>strip</span>
    <span class='stderr_result identifier id'>stderr_result</span> <span class='assign token'>=</span> <span class='stderr identifier id'>stderr</span><span class='dot token'>.</span><span class='read identifier id'>read</span><span class='dot token'>.</span><span class='strip identifier id'>strip</span>

  <span class='return return kw'>return</span> <span class='lbrack token'>[</span><span class='cmd identifier id'>cmd</span><span class='comma token'>,</span> <span class='status identifier id'>status</span><span class='comma token'>,</span> <span class='stdout_result identifier id'>stdout_result</span><span class='comma token'>,</span> <span class='stderr_result identifier id'>stderr_result</span><span class='rbrack token'>]</span>    
<span class='end end kw'>end</span>
</pre>
    
  </div>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/plist4r/mixin/popen4.rb', line 36</span>

<span class='def def kw'>def</span> <span class='popen4 identifier id'>popen4</span><span class='lparen token'>(</span><span class='cmd identifier id'>cmd</span><span class='comma token'>,</span> <span class='args identifier id'>args</span><span class='assign token'>=</span><span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='b identifier id'>b</span><span class='rparen token'>)</span>
   
  <span class='comment val'># Waitlast - this is magic.  </span>
  <span class='comment val'># </span>
  <span class='comment val'># Do we wait for the child process to die before we yield</span>
  <span class='comment val'># to the block, or after?  That is the magic of waitlast.</span>
  <span class='comment val'>#</span>
  <span class='comment val'># By default, we are waiting before we yield the block.</span>
  <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:waitlast</span><span class='rbrack token'>]</span> <span class='opasgn op'>||=</span> <span class='false false kw'>false</span>
    
  <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:user</span><span class='rbrack token'>]</span> <span class='opasgn op'>||=</span> <span class='nil nil kw'>nil</span>
  <span class='unless unless kw'>unless</span> <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:user</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='kind_of? fid id'>kind_of?</span><span class='lparen token'>(</span><span class='Integer constant id'>Integer</span><span class='rparen token'>)</span>
    <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:user</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='Etc constant id'>Etc</span><span class='dot token'>.</span><span class='getpwnam identifier id'>getpwnam</span><span class='lparen token'>(</span><span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:user</span><span class='rbrack token'>]</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='uid identifier id'>uid</span> <span class='if if_mod kw'>if</span> <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:user</span><span class='rbrack token'>]</span>
  <span class='end end kw'>end</span>
  <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:group</span><span class='rbrack token'>]</span> <span class='opasgn op'>||=</span> <span class='nil nil kw'>nil</span>
  <span class='unless unless kw'>unless</span> <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:group</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='kind_of? fid id'>kind_of?</span><span class='lparen token'>(</span><span class='Integer constant id'>Integer</span><span class='rparen token'>)</span>
    <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:group</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='Etc constant id'>Etc</span><span class='dot token'>.</span><span class='getgrnam identifier id'>getgrnam</span><span class='lparen token'>(</span><span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:group</span><span class='rbrack token'>]</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='gid identifier id'>gid</span> <span class='if if_mod kw'>if</span> <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:group</span><span class='rbrack token'>]</span>
  <span class='end end kw'>end</span>
  <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:environment</span><span class='rbrack token'>]</span> <span class='opasgn op'>||=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>

  <span class='comment val'># Default on C locale so parsing commands output can be done</span>
  <span class='comment val'># independently of the node's default locale.</span>
  <span class='comment val'># &quot;LC_ALL&quot; could be set to nil, in which case we also must ignore it.</span>
  <span class='unless unless kw'>unless</span> <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:environment</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='has_key? fid id'>has_key?</span><span class='lparen token'>(</span><span class='string val'>&quot;LC_ALL&quot;</span><span class='rparen token'>)</span>
    <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:environment</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='string val'>&quot;LC_ALL&quot;</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='string val'>&quot;C&quot;</span>
  <span class='end end kw'>end</span>
    
  <span class='pw identifier id'>pw</span><span class='comma token'>,</span> <span class='pr identifier id'>pr</span><span class='comma token'>,</span> <span class='pe identifier id'>pe</span><span class='comma token'>,</span> <span class='ps identifier id'>ps</span> <span class='assign token'>=</span> <span class='IO constant id'>IO</span><span class='dot token'>.</span><span class='pipe identifier id'>pipe</span><span class='comma token'>,</span> <span class='IO constant id'>IO</span><span class='dot token'>.</span><span class='pipe identifier id'>pipe</span><span class='comma token'>,</span> <span class='IO constant id'>IO</span><span class='dot token'>.</span><span class='pipe identifier id'>pipe</span><span class='comma token'>,</span> <span class='IO constant id'>IO</span><span class='dot token'>.</span><span class='pipe identifier id'>pipe</span>

  <span class='verbose identifier id'>verbose</span> <span class='assign token'>=</span> <span class='$VERBOSE gvar id'>$VERBOSE</span>
  <span class='begin begin kw'>begin</span>
    <span class='$VERBOSE gvar id'>$VERBOSE</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
    <span class='ps identifier id'>ps</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='dot token'>.</span><span class='fcntl identifier id'>fcntl</span><span class='lparen token'>(</span><span class='Fcntl constant id'>Fcntl</span><span class='colon2 op'>::</span><span class='F_SETFD constant id'>F_SETFD</span><span class='comma token'>,</span> <span class='Fcntl constant id'>Fcntl</span><span class='colon2 op'>::</span><span class='FD_CLOEXEC constant id'>FD_CLOEXEC</span><span class='rparen token'>)</span>

    <span class='cid identifier id'>cid</span> <span class='assign token'>=</span> <span class='fork identifier id'>fork</span> <span class='lbrace token'>{</span>
      <span class='pw identifier id'>pw</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='dot token'>.</span><span class='close identifier id'>close</span>
      <span class='STDIN constant id'>STDIN</span><span class='dot token'>.</span><span class='reopen identifier id'>reopen</span> <span class='pw identifier id'>pw</span><span class='dot token'>.</span><span class='first identifier id'>first</span>
      <span class='pw identifier id'>pw</span><span class='dot token'>.</span><span class='first identifier id'>first</span><span class='dot token'>.</span><span class='close identifier id'>close</span>

      <span class='pr identifier id'>pr</span><span class='dot token'>.</span><span class='first identifier id'>first</span><span class='dot token'>.</span><span class='close identifier id'>close</span>
      <span class='STDOUT constant id'>STDOUT</span><span class='dot token'>.</span><span class='reopen identifier id'>reopen</span> <span class='pr identifier id'>pr</span><span class='dot token'>.</span><span class='last identifier id'>last</span>
      <span class='pr identifier id'>pr</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='dot token'>.</span><span class='close identifier id'>close</span>

      <span class='pe identifier id'>pe</span><span class='dot token'>.</span><span class='first identifier id'>first</span><span class='dot token'>.</span><span class='close identifier id'>close</span>
      <span class='STDERR constant id'>STDERR</span><span class='dot token'>.</span><span class='reopen identifier id'>reopen</span> <span class='pe identifier id'>pe</span><span class='dot token'>.</span><span class='last identifier id'>last</span>
      <span class='pe identifier id'>pe</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='dot token'>.</span><span class='close identifier id'>close</span>

      <span class='STDOUT constant id'>STDOUT</span><span class='dot token'>.</span><span class='sync identifier id'>sync</span> <span class='assign token'>=</span> <span class='STDERR constant id'>STDERR</span><span class='dot token'>.</span><span class='sync identifier id'>sync</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>

      <span class='if if kw'>if</span> <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:group</span><span class='rbrack token'>]</span>
        <span class='Process constant id'>Process</span><span class='dot token'>.</span><span class='egid identifier id'>egid</span> <span class='assign token'>=</span> <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:group</span><span class='rbrack token'>]</span>
        <span class='Process constant id'>Process</span><span class='dot token'>.</span><span class='gid identifier id'>gid</span> <span class='assign token'>=</span> <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:group</span><span class='rbrack token'>]</span>
      <span class='end end kw'>end</span>

      <span class='if if kw'>if</span> <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:user</span><span class='rbrack token'>]</span>
        <span class='Process constant id'>Process</span><span class='dot token'>.</span><span class='euid identifier id'>euid</span> <span class='assign token'>=</span> <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:user</span><span class='rbrack token'>]</span>
        <span class='Process constant id'>Process</span><span class='dot token'>.</span><span class='uid identifier id'>uid</span> <span class='assign token'>=</span> <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:user</span><span class='rbrack token'>]</span>
      <span class='end end kw'>end</span>
  
      <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:environment</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='key identifier id'>key</span><span class='comma token'>,</span><span class='value identifier id'>value</span><span class='bitor op'>|</span>
        <span class='ENV constant id'>ENV</span><span class='lbrack token'>[</span><span class='key identifier id'>key</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='value identifier id'>value</span>
      <span class='end end kw'>end</span>

      <span class='if if kw'>if</span> <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:umask</span><span class='rbrack token'>]</span>
        <span class='umask identifier id'>umask</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='lparen token'>(</span><span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:umask</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='respond_to? fid id'>respond_to?</span><span class='lparen token'>(</span><span class='symbol val'>:oct</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:umask</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='oct identifier id'>oct</span> <span class='colon op'>:</span> <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:umask</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span><span class='rparen token'>)</span> <span class='bitand op'>&amp;</span> <span class='integer val'>007777</span><span class='rparen token'>)</span>
        <span class='File constant id'>File</span><span class='dot token'>.</span><span class='umask identifier id'>umask</span><span class='lparen token'>(</span><span class='umask identifier id'>umask</span><span class='rparen token'>)</span>
      <span class='end end kw'>end</span>
  
      <span class='begin begin kw'>begin</span>
        <span class='if if kw'>if</span> <span class='cmd identifier id'>cmd</span><span class='dot token'>.</span><span class='kind_of? fid id'>kind_of?</span><span class='lparen token'>(</span><span class='Array constant id'>Array</span><span class='rparen token'>)</span>
          <span class='exec identifier id'>exec</span><span class='lparen token'>(</span><span class='mult op'>*</span><span class='cmd identifier id'>cmd</span><span class='rparen token'>)</span>
        <span class='else else kw'>else</span>
          <span class='exec identifier id'>exec</span><span class='lparen token'>(</span><span class='cmd identifier id'>cmd</span><span class='rparen token'>)</span>
        <span class='end end kw'>end</span>
        <span class='raise identifier id'>raise</span> <span class='string val'>'forty-two'</span> 
      <span class='rescue rescue kw'>rescue</span> <span class='Exception constant id'>Exception</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
        <span class='Marshal constant id'>Marshal</span><span class='dot token'>.</span><span class='dump identifier id'>dump</span><span class='lparen token'>(</span><span class='e identifier id'>e</span><span class='comma token'>,</span> <span class='ps identifier id'>ps</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='rparen token'>)</span>
        <span class='ps identifier id'>ps</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='dot token'>.</span><span class='flush identifier id'>flush</span>
      <span class='end end kw'>end</span>
      <span class='ps identifier id'>ps</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='dot token'>.</span><span class='close identifier id'>close</span> <span class='unless unless_mod kw'>unless</span> <span class='lparen token'>(</span><span class='ps identifier id'>ps</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='dot token'>.</span><span class='closed? fid id'>closed?</span><span class='rparen token'>)</span>
      <span class='exit! fid id'>exit!</span>
    <span class='rbrace token'>}</span>
  <span class='ensure ensure kw'>ensure</span>
    <span class='$VERBOSE gvar id'>$VERBOSE</span> <span class='assign token'>=</span> <span class='verbose identifier id'>verbose</span>
  <span class='end end kw'>end</span>

  <span class='lbrack token'>[</span><span class='pw identifier id'>pw</span><span class='dot token'>.</span><span class='first identifier id'>first</span><span class='comma token'>,</span> <span class='pr identifier id'>pr</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='comma token'>,</span> <span class='pe identifier id'>pe</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='comma token'>,</span> <span class='ps identifier id'>ps</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='each identifier id'>each</span><span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='fd identifier id'>fd</span><span class='bitor op'>|</span> <span class='fd identifier id'>fd</span><span class='dot token'>.</span><span class='close identifier id'>close</span><span class='rbrace token'>}</span>

  <span class='begin begin kw'>begin</span>
    <span class='e identifier id'>e</span> <span class='assign token'>=</span> <span class='Marshal constant id'>Marshal</span><span class='dot token'>.</span><span class='load identifier id'>load</span> <span class='ps identifier id'>ps</span><span class='dot token'>.</span><span class='first identifier id'>first</span>
    <span class='raise identifier id'>raise</span><span class='lparen token'>(</span><span class='Exception constant id'>Exception</span> <span class='eqq op'>===</span> <span class='e identifier id'>e</span> <span class='integer val'>? </span><span class='e identifier id'>e</span> <span class='colon op'>:</span> <span class='string val'>&quot;unknown failure!&quot;</span><span class='rparen token'>)</span>
  <span class='rescue rescue kw'>rescue</span> <span class='EOFError constant id'>EOFError</span> <span class='comment val'># If we get an EOF error, then the exec was successful</span>
    <span class='integer val'>42</span>
  <span class='ensure ensure kw'>ensure</span>
    <span class='ps identifier id'>ps</span><span class='dot token'>.</span><span class='first identifier id'>first</span><span class='dot token'>.</span><span class='close identifier id'>close</span>
  <span class='end end kw'>end</span>

  <span class='pw identifier id'>pw</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='dot token'>.</span><span class='sync identifier id'>sync</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>

  <span class='pi identifier id'>pi</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='pw identifier id'>pw</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='comma token'>,</span> <span class='pr identifier id'>pr</span><span class='dot token'>.</span><span class='first identifier id'>first</span><span class='comma token'>,</span> <span class='pe identifier id'>pe</span><span class='dot token'>.</span><span class='first identifier id'>first</span><span class='rbrack token'>]</span>

  <span class='if if kw'>if</span> <span class='b identifier id'>b</span> 
    <span class='begin begin kw'>begin</span>
      <span class='if if kw'>if</span> <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:waitlast</span><span class='rbrack token'>]</span>
        <span class='b identifier id'>b</span><span class='lbrack token'>[</span><span class='cid identifier id'>cid</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='pi identifier id'>pi</span><span class='rbrack token'>]</span>
        <span class='comment val'># send EOF so that if the child process is reading from STDIN</span>
        <span class='comment val'># it will actually finish up and exit</span>
        <span class='pi identifier id'>pi</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='close_write identifier id'>close_write</span>
        <span class='Process constant id'>Process</span><span class='dot token'>.</span><span class='waitpid2 identifier id'>waitpid2</span><span class='lparen token'>(</span><span class='cid identifier id'>cid</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='last identifier id'>last</span>
      <span class='else else kw'>else</span>
        <span class='comment val'># This took some doing.</span>
        <span class='comment val'># The trick here is to close STDIN</span>
        <span class='comment val'># Then set our end of the childs pipes to be O_NONBLOCK</span>
        <span class='comment val'># Then wait for the child to die, which means any IO it</span>
        <span class='comment val'># wants to do must be done - it's dead.  If it isn't,</span>
        <span class='comment val'># it's because something totally skanky is happening,</span>
        <span class='comment val'># and we don't care.</span>
        <span class='o identifier id'>o</span> <span class='assign token'>=</span> <span class='StringIO constant id'>StringIO</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
        <span class='e identifier id'>e</span> <span class='assign token'>=</span> <span class='StringIO constant id'>StringIO</span><span class='dot token'>.</span><span class='new identifier id'>new</span>

        <span class='pi identifier id'>pi</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='close identifier id'>close</span>
    
        <span class='stdout identifier id'>stdout</span> <span class='assign token'>=</span> <span class='pi identifier id'>pi</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span>
        <span class='stderr identifier id'>stderr</span> <span class='assign token'>=</span> <span class='pi identifier id'>pi</span><span class='lbrack token'>[</span><span class='integer val'>2</span><span class='rbrack token'>]</span>

        <span class='stdout identifier id'>stdout</span><span class='dot token'>.</span><span class='sync identifier id'>sync</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>
        <span class='stderr identifier id'>stderr</span><span class='dot token'>.</span><span class='sync identifier id'>sync</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>

        <span class='stdout identifier id'>stdout</span><span class='dot token'>.</span><span class='fcntl identifier id'>fcntl</span><span class='lparen token'>(</span><span class='Fcntl constant id'>Fcntl</span><span class='colon2 op'>::</span><span class='F_SETFL constant id'>F_SETFL</span><span class='comma token'>,</span> <span class='pi identifier id'>pi</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='fcntl identifier id'>fcntl</span><span class='lparen token'>(</span><span class='Fcntl constant id'>Fcntl</span><span class='colon2 op'>::</span><span class='F_GETFL constant id'>F_GETFL</span><span class='rparen token'>)</span> <span class='bitor op'>|</span> <span class='Fcntl constant id'>Fcntl</span><span class='colon2 op'>::</span><span class='O_NONBLOCK constant id'>O_NONBLOCK</span><span class='rparen token'>)</span>
        <span class='stderr identifier id'>stderr</span><span class='dot token'>.</span><span class='fcntl identifier id'>fcntl</span><span class='lparen token'>(</span><span class='Fcntl constant id'>Fcntl</span><span class='colon2 op'>::</span><span class='F_SETFL constant id'>F_SETFL</span><span class='comma token'>,</span> <span class='pi identifier id'>pi</span><span class='lbrack token'>[</span><span class='integer val'>2</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='fcntl identifier id'>fcntl</span><span class='lparen token'>(</span><span class='Fcntl constant id'>Fcntl</span><span class='colon2 op'>::</span><span class='F_GETFL constant id'>F_GETFL</span><span class='rparen token'>)</span> <span class='bitor op'>|</span> <span class='Fcntl constant id'>Fcntl</span><span class='colon2 op'>::</span><span class='O_NONBLOCK constant id'>O_NONBLOCK</span><span class='rparen token'>)</span>
    
        <span class='stdout_finished identifier id'>stdout_finished</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>
        <span class='stderr_finished identifier id'>stderr_finished</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>
   
        <span class='results identifier id'>results</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>

        <span class='while while kw'>while</span> <span class='notop op'>!</span><span class='stdout_finished identifier id'>stdout_finished</span> <span class='orop op'>||</span> <span class='notop op'>!</span><span class='stderr_finished identifier id'>stderr_finished</span>
          <span class='begin begin kw'>begin</span>
            <span class='channels_to_watch identifier id'>channels_to_watch</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
            <span class='channels_to_watch identifier id'>channels_to_watch</span> <span class='lshft op'>&lt;&lt;</span> <span class='stdout identifier id'>stdout</span> <span class='if if_mod kw'>if</span> <span class='notop op'>!</span><span class='stdout_finished identifier id'>stdout_finished</span>
            <span class='channels_to_watch identifier id'>channels_to_watch</span> <span class='lshft op'>&lt;&lt;</span> <span class='stderr identifier id'>stderr</span> <span class='if if_mod kw'>if</span> <span class='notop op'>!</span><span class='stderr_finished identifier id'>stderr_finished</span>
            <span class='ready identifier id'>ready</span> <span class='assign token'>=</span> <span class='IO constant id'>IO</span><span class='dot token'>.</span><span class='select identifier id'>select</span><span class='lparen token'>(</span><span class='channels_to_watch identifier id'>channels_to_watch</span><span class='comma token'>,</span> <span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='float val'>1.0</span><span class='rparen token'>)</span>
          <span class='rescue rescue kw'>rescue</span> <span class='Errno constant id'>Errno</span><span class='colon2 op'>::</span><span class='EAGAIN constant id'>EAGAIN</span>
          <span class='ensure ensure kw'>ensure</span>
            <span class='results identifier id'>results</span> <span class='assign token'>=</span> <span class='Process constant id'>Process</span><span class='dot token'>.</span><span class='waitpid2 identifier id'>waitpid2</span><span class='lparen token'>(</span><span class='cid identifier id'>cid</span><span class='comma token'>,</span> <span class='Process constant id'>Process</span><span class='colon2 op'>::</span><span class='WNOHANG constant id'>WNOHANG</span><span class='rparen token'>)</span>
            <span class='if if kw'>if</span> <span class='results identifier id'>results</span>
              <span class='stdout_finished identifier id'>stdout_finished</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>
              <span class='stderr_finished identifier id'>stderr_finished</span> <span class='assign token'>=</span> <span class='true true kw'>true</span> 
            <span class='end end kw'>end</span>
          <span class='end end kw'>end</span>

          <span class='if if kw'>if</span> <span class='ready identifier id'>ready</span> <span class='andop op'>&amp;&amp;</span> <span class='ready identifier id'>ready</span><span class='dot token'>.</span><span class='first identifier id'>first</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='stdout identifier id'>stdout</span><span class='rparen token'>)</span>
            <span class='line identifier id'>line</span> <span class='assign token'>=</span> <span class='results identifier id'>results</span> <span class='integer val'>? </span><span class='stdout identifier id'>stdout</span><span class='dot token'>.</span><span class='gets identifier id'>gets</span><span class='lparen token'>(</span><span class='nil nil kw'>nil</span><span class='rparen token'>)</span> <span class='colon op'>:</span> <span class='stdout identifier id'>stdout</span><span class='dot token'>.</span><span class='gets identifier id'>gets</span>
            <span class='if if kw'>if</span> <span class='line identifier id'>line</span>
              <span class='o identifier id'>o</span><span class='dot token'>.</span><span class='write identifier id'>write</span><span class='lparen token'>(</span><span class='line identifier id'>line</span><span class='rparen token'>)</span>
            <span class='else else kw'>else</span>
              <span class='stdout_finished identifier id'>stdout_finished</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>
            <span class='end end kw'>end</span>
          <span class='end end kw'>end</span>
          <span class='if if kw'>if</span> <span class='ready identifier id'>ready</span> <span class='andop op'>&amp;&amp;</span> <span class='ready identifier id'>ready</span><span class='dot token'>.</span><span class='first identifier id'>first</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='stderr identifier id'>stderr</span><span class='rparen token'>)</span>
            <span class='line identifier id'>line</span> <span class='assign token'>=</span> <span class='results identifier id'>results</span> <span class='integer val'>? </span><span class='stderr identifier id'>stderr</span><span class='dot token'>.</span><span class='gets identifier id'>gets</span><span class='lparen token'>(</span><span class='nil nil kw'>nil</span><span class='rparen token'>)</span> <span class='colon op'>:</span> <span class='stderr identifier id'>stderr</span><span class='dot token'>.</span><span class='gets identifier id'>gets</span>
            <span class='if if kw'>if</span> <span class='line identifier id'>line</span>
              <span class='e identifier id'>e</span><span class='dot token'>.</span><span class='write identifier id'>write</span><span class='lparen token'>(</span><span class='line identifier id'>line</span><span class='rparen token'>)</span>
            <span class='else else kw'>else</span>
              <span class='stderr_finished identifier id'>stderr_finished</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>
            <span class='end end kw'>end</span>
          <span class='end end kw'>end</span>
        <span class='end end kw'>end</span>
        <span class='results identifier id'>results</span> <span class='assign token'>=</span> <span class='Process constant id'>Process</span><span class='dot token'>.</span><span class='waitpid2 identifier id'>waitpid2</span><span class='lparen token'>(</span><span class='cid identifier id'>cid</span><span class='rparen token'>)</span> <span class='unless unless_mod kw'>unless</span> <span class='results identifier id'>results</span>
        <span class='o identifier id'>o</span><span class='dot token'>.</span><span class='rewind identifier id'>rewind</span>
        <span class='e identifier id'>e</span><span class='dot token'>.</span><span class='rewind identifier id'>rewind</span>
        <span class='b identifier id'>b</span><span class='lbrack token'>[</span><span class='cid identifier id'>cid</span><span class='comma token'>,</span> <span class='pi identifier id'>pi</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='o identifier id'>o</span><span class='comma token'>,</span> <span class='e identifier id'>e</span><span class='rbrack token'>]</span>
        <span class='results identifier id'>results</span><span class='dot token'>.</span><span class='last identifier id'>last</span>
      <span class='end end kw'>end</span>
    <span class='ensure ensure kw'>ensure</span>
      <span class='pi identifier id'>pi</span><span class='dot token'>.</span><span class='each identifier id'>each</span><span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='fd identifier id'>fd</span><span class='bitor op'>|</span> <span class='fd identifier id'>fd</span><span class='dot token'>.</span><span class='close identifier id'>close</span> <span class='unless unless_mod kw'>unless</span> <span class='fd identifier id'>fd</span><span class='dot token'>.</span><span class='closed? fid id'>closed?</span><span class='rbrace token'>}</span>
    <span class='end end kw'>end</span>
  <span class='else else kw'>else</span>
    <span class='lbrack token'>[</span><span class='cid identifier id'>cid</span><span class='comma token'>,</span> <span class='pw identifier id'>pw</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='comma token'>,</span> <span class='pr identifier id'>pr</span><span class='dot token'>.</span><span class='first identifier id'>first</span><span class='comma token'>,</span> <span class='pe identifier id'>pe</span><span class='dot token'>.</span><span class='first identifier id'>first</span><span class='rbrack token'>]</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
    </td>
  </tr>
</table>
</div>

    
  </div>

</div>
    
    <div id="footer">
  Generated on Sun Jul  4 18:15:21 2010 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool">yard</a>
  0.5.8  and the 
  <a href="http://github.com/dreamcat4/yard-slipstream">yard-slipstream</a> plugin
	(ruby-1.8.7).
</div>

  </body>
</html>